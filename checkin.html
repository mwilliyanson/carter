<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Selfie Attendance</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Make selfie camera mirrored */
    #video {
      transform: scaleX(-1);
    }
    #canvas {
      transform: scaleX(-1);
    }
  </style>
</head>
<body class="bg-gray-100 flex flex-col items-center justify-center min-h-screen p-4">
  <div class="bg-white shadow-lg rounded-2xl p-6 w-full max-w-sm">
    <h2 class="text-2xl font-bold text-center mb-4">üì∏ Selfie Attendance</h2>

    <!-- Camera preview -->
    <div class="relative aspect-[3/4] w-full">
      <video id="video" autoplay playsinline class="rounded-lg w-full h-full object-cover border border-gray-300"></video>
      <canvas id="canvas" class="hidden"></canvas>
      <!-- Overlay timestamp/location -->
      <div id="overlay" 
           class="absolute bottom-2 left-2 bg-black bg-opacity-60 text-white text-xs px-2 py-1 rounded">
        Waiting for location...
      </div>
    </div>

    <button id="snap" 
            class="mt-4 w-full bg-blue-600 text-white py-2 rounded-lg font-semibold hover:bg-blue-700 transition disabled:bg-gray-400 disabled:cursor-not-allowed"
            disabled>
      Take & Upload Selfie
    </button>

    <p id="status" class="mt-3 text-center text-gray-600 text-sm"></p>
  </div>

  <script>
    const video = document.getElementById("video");
    const canvas = document.getElementById("canvas");
    const snapBtn = document.getElementById("snap");
    const overlay = document.getElementById("overlay");
    const statusEl = document.getElementById("status");
    const ctx = canvas.getContext("2d");

    let lat = null, lon = null;

    // Start camera (prefer portrait / user-facing camera)
    navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } })
      .then(stream => {
        video.srcObject = stream;
        video.addEventListener("loadedmetadata", () => {
          // Match canvas size with video size
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
        });
      })
      .catch(err => alert("Camera access denied: " + err));

    // Get geolocation
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        pos => {
          lat = pos.coords.latitude;
          lon = pos.coords.longitude;
          overlay.textContent = "üìç Lat: " + lat.toFixed(5) + ", Lon: " + lon.toFixed(5);
          snapBtn.disabled = false; // enable button only if GPS is available
        },
        err => {
          overlay.textContent = "‚ùå Enable location to continue";
          snapBtn.disabled = true;
          console.warn("Geolocation error:", err);
        }
      );
    } else {
      overlay.textContent = "‚ùå Geolocation not supported";
      snapBtn.disabled = true;
    }

    // Update overlay with timestamp every second
    setInterval(() => {
      const now = new Date();
      const timeStr = now.toLocaleString();
      if (lat && lon) {
        overlay.textContent = `${timeStr} | üìç ${lat.toFixed(5)}, ${lon.toFixed(5)}`;
      } else {
        overlay.textContent = "‚ùå Location required";
      }
    }, 1000);

    snapBtn.addEventListener("click", async () => {
      // Draw video to canvas
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

      // Draw timestamp + GPS on canvas
      ctx.fillStyle = "rgba(0,0,0,0.6)";
      ctx.fillRect(5, canvas.height - 30, canvas.width - 10, 25);
      ctx.fillStyle = "white";
      ctx.font = "14px sans-serif";
      const now = new Date().toLocaleString();
      const geoText = lat && lon ? ` | üìç ${lat.toFixed(5)}, ${lon.toFixed(5)}` : "";
      ctx.fillText(now + geoText, 10, canvas.height - 12);

      canvas.toBlob(async (blob) => {
        const arrayBuffer = await blob.arrayBuffer();
        const base64 = btoa(
          new Uint8Array(arrayBuffer).reduce((data, byte) => data + String.fromCharCode(byte), "")
        );

        const payload = {
          userId: "123",
          displayedName: "John Doe",
          type: "attendance",
          fileAttachment: [
            {
              mimetype: blob.type,
              size: blob.size,
              title: "selfie.png",
              url: `data:${blob.type};base64,${base64}`,
              icon: "üìé"
            }
          ],
          metadata: JSON.stringify({
            timestamp: new Date().toISOString(),
            latitude: lat,
            longitude: lon
          })
        };

        try {
          statusEl.textContent = "‚è≥ Uploading...";
          const res = await fetch("https://seahorse-app-4a2zl.ondigitalocean.app/api/v2/tables/mni57oyzaeuzycp/records", {
            method: "POST",
            headers: {
              "accept": "application/json",
              "xc-auth": "ukRD8FLCnaROjoGuAqgM5ZItgkBPVdxj0wR3lLHN",
              "xc-token": "ukRD8FLCnaROjoGuAqgM5ZItgkBPVdxj0wR3lLHN",
              "Content-Type": "application/json"
            },
            body: JSON.stringify(payload)
          });

          const result = await res.json();
          console.log("‚úÖ Upload result:", result);
          statusEl.textContent = "‚úÖ Selfie uploaded successfully!";
        } catch (err) {
          console.error("‚ùå Upload failed:", err);
          statusEl.textContent = "‚ùå Upload failed. Check console.";
        }
      }, "image/png");
    });
  </script>
</body>
</html>
