<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Payslip - PT Bicarakan Jiwa Pelita</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    .truncate-ellipsis {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: 180px;
      display: inline-block;
      vertical-align: bottom;
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-800">
  <div class="max-w-3xl mx-auto p-4 sm:p-6 lg:p-8 bg-white shadow-lg rounded-xl">
    <!-- Header -->
    <div class="flex flex-col sm:flex-row items-center sm:items-start sm:justify-between mb-6">
      <img src="https://bicarakan.id/logo_text.svg" alt="Company Logo" class="h-12 mb-4 sm:mb-0">
      <div class="text-center sm:text-right">
        <h1 class="text-lg font-semibold">PT Bicarakan Isi Hatimu</h1>
        <p class="text-sm text-gray-600">
          IDX Tower 1<br>
          Jl. Jenderal Sudirman No.304 Level 3, Senayan<br>
          DKI Jakarta 12190
        </p>
      </div>
    </div>

    <!-- Hidden Form -->
    <div class="hidden">
      <input type="text" id="employeeId">
      <input type="text" id="payrollCode">
      <input type="date" id="startDate">
      <input type="date" id="endDate">
      <button onclick="fetchPayslip()">Get Payslip</button>
    </div>

    <!-- Payslip -->
    <div id="payslipContainer" class="hidden mt-8">
      <h2 class="text-xl font-bold mb-2 text-center">Payslip</h2>
      <p id="payslip-period" class="text-center text-gray-600 mb-6">Period: <span></span></p>

      <!-- Employee Info -->
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6 text-sm">
        <div>
          <p><strong>Employee Name:</strong> <span id="empName"></span></p>
          <p><strong>Employee ID:</strong> <span id="empId" class="truncate-ellipsis" title=""></span></p>
        </div>
        <div>
          <p><strong>Department:</strong> <span id="empDept"></span></p>
          <p><strong>Position:</strong> <span id="empPos"></span></p>
        </div>
      </div>

      <!-- Table -->
      <div class="overflow-x-auto">
        <table class="w-full border-collapse border border-gray-300 text-sm sm:text-base">
          <thead class="bg-gray-100">
            <tr>
              <th class="border border-gray-300 px-4 py-2 text-left">Description</th>
              <th class="border border-gray-300 px-4 py-2 text-right">Amount (IDR)</th>
            </tr>
          </thead>
          <tbody id="payslipBody"></tbody>
        </table>
      </div>

      <!-- Footer -->
      <p class="text-xs text-gray-500 mt-6 text-center">
        This payslip is system generated. For any questions or references, feel free to email 
        <a href="mailto:finance@bicarakan.id" class="text-blue-600 underline">finance@bicarakan.id</a>.
      </p>
    </div>
  </div>

  <script>
    function getQueryParams() {
      const params = {};
      const queryString = window.location.search.substring(1);
      const pairs = queryString.split("&");
      for (const pair of pairs) {
        if (!pair) continue;
        const [key, value] = pair.split("=");
        params[decodeURIComponent(key)] = decodeURIComponent(value || "");
      }
      return params;
    }

    function calculateEndPeriod(startPeriodStr) {
      const start = new Date(startPeriodStr);
      if (isNaN(start)) return "";
      const end = new Date(start);
      end.setMonth(end.getMonth() + 1);
      end.setDate(20);
      return end.toISOString().split("T")[0];
    }

    window.addEventListener("DOMContentLoaded", () => {
      const params = getQueryParams();

      if (params.id) {
        document.getElementById("employeeId").value = params.id;
      }
      if (params.code) {
        document.getElementById("payrollCode").value = params.code;
      }
      if (params.period) {
        document.getElementById("startDate").value = params.period;
        const endPeriod = calculateEndPeriod(params.period);
        if (endPeriod) {
          document.getElementById("endDate").value = endPeriod;
        }
      }

      // auto-fetch if all required params exist
      if (params.id && params.period && params.code) {
        fetchPayslip();
      }
    });

    async function fetchPayslip() {
      const employeeId = document.getElementById("employeeId").value.trim();
      const payrollCode = document.getElementById("payrollCode").value.trim();
      const startDate = document.getElementById("startDate").value;
      const endDate = document.getElementById("endDate").value;

      if (!employeeId || !payrollCode || !startDate || !endDate) {
        alert("Please enter Employee ID, Payroll Code, Start Date, and End Date.");
        return;
      }

      try {
        const res = await fetch("https://gopher.bicarakan.id/lydians/payroll/get", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "x-api-key": "B3mJnGSf.zYPOv6oxB4tUlFvwqK3o1DeCeNDivkTT",
            "App-Version-Code": "10",
            "App-Version-Name": "0.1.0",
            "locale": "en_US",
            "platform": "Web",
            "Accept-Language": "id-ID,id;q=0.9,en-US;q=0.8,en;q=0.7",
            "Content-Language": "id-ID",
            "Authorization": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
          },
          body: JSON.stringify({
            payroll_code: payrollCode,
            payroll_employee_id: employeeId,
            payroll_start_period: startDate,
            payroll_end_period: endDate
          })
        });

        const json = await res.json();
        const payroll = json.data?.payroll_detail_response;

        if (!payroll) {
          alert("No payslip data found.");
          return;
        }

        document.getElementById("payslipContainer").classList.remove("hidden");

        document.getElementById("empName").textContent = payroll.employee_name;
        document.getElementById("empId").textContent = payroll.employee_id;
        document.getElementById("empId").title = payroll.employee_id;
        document.getElementById("empDept").textContent = payroll.department;
        document.getElementById("empPos").textContent = payroll.position;

        const start = new Date(payroll.period_start);
        const end = new Date(payroll.period_end);
        document.getElementById("payslip-period").querySelector("span").textContent =
          `${start.toLocaleDateString()} - ${end.toLocaleDateString()}`;

        const tbody = document.getElementById("payslipBody");
        tbody.innerHTML = "";

        addSectionHeader("Earnings", tbody);
        addRowIfNotZero("Base Salary", payroll.base_salary, tbody);
        for (const [name, value] of Object.entries(payroll.allowances || {})) {
          addRowIfNotZero(name, value, tbody);
        }
        addRowIfNotZero("Gross Earning", payroll.gross_earning, tbody, true);

        addSectionHeader("Deductions", tbody);
        for (const [name, value] of Object.entries(payroll.deductions || {})) {
          addRowIfNotZero(name, value, tbody);
        }
        addRowIfNotZero("Tax", payroll.tax, tbody);

        addSectionHeader("Net", tbody);
        addRowIfNotZero("Net Earning", payroll.net_earning, tbody, false, true);
      } catch (err) {
        console.error(err);
        alert("Failed to fetch payslip.");
      }
    }

    function addSectionHeader(title, tbody) {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td colspan="2" class="bg-gray-50 text-gray-700 font-semibold px-4 py-2">${title}</td>
      `;
      tbody.appendChild(tr);
    }

    function addRowIfNotZero(name, amount, tbody, bold = false, highlight = false) {
      if (!amount || amount === 0) return;
      const tr = document.createElement("tr");
      tr.className = highlight ? "bg-green-100 font-bold" : "";
      tr.innerHTML = `
        <td class="border border-gray-300 px-4 py-2 ${bold ? "font-semibold" : ""}">${name}</td>
        <td class="border border-gray-300 px-4 py-2 text-right ${bold ? "font-semibold" : ""}">${formatIDR(amount)}</td>
      `;
      tbody.appendChild(tr);
    }

    function formatIDR(num) {
      return new Intl.NumberFormat("id-ID", { style: "currency", currency: "IDR" }).format(num || 0);
    }
  </script>
</body>
</html>
