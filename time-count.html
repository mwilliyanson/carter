<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Attendance Summary</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 40px;
      background: #fafafa;
      color: #333;
    }
    h1 { text-align: center; }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: white;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 10px;
      text-align: left;
    }
    th { background: #f0f0f0; }
    tr:hover { background: #f9f9f9; cursor: pointer; }
    .total {
      margin-top: 20px;
      font-size: 1.2em;
      font-weight: bold;
      text-align: right;
    }
    .modal {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.4);
      justify-content: center;
      align-items: center;
      z-index: 10;
    }
    .modal-content {
      background: white;
      padding: 20px;
      border-radius: 10px;
      width: 90%;
      max-width: 700px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      max-height: 80vh;
      overflow-y: auto;
    }
    .close-btn {
      float: right;
      cursor: pointer;
      color: #666;
      font-weight: bold;
    }
    .hours-low { color: red; font-weight: bold; }
    .record-photo {
      width: 80px;
      height: 80px;
      border-radius: 8px;
      object-fit: cover;
    }
  </style>
</head>
<body>
  <h1>Attendance Summary</h1>

  <table id="attendanceTable">
    <thead>
      <tr><th>Name</th><th>Days Attended</th></tr>
    </thead>
    <tbody></tbody>
  </table>
  <div class="total" id="total"></div>

  <!-- Modal for daily summary -->
  <div class="modal" id="detailModal">
    <div class="modal-content">
      <span class="close-btn" id="closeModal">&times;</span>
      <h2 id="modalTitle"></h2>
      <table id="detailTable">
        <thead><tr><th>Date</th><th>Total Hours</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- Modal for raw records -->
  <div class="modal" id="recordModal">
    <div class="modal-content">
      <span class="close-btn" id="closeRecordModal">&times;</span>
      <h2 id="recordTitle"></h2>
      <table id="recordTable">
        <!-- ✅ Added Annotation column -->
        <thead>
          <tr><th>Time</th><th>Action</th><th>Photo</th><th>Annotation</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script>
    let attendanceMap = {};

    async function loadAttendance() {
      const res = await fetch("https://seahorse-app-4a2zl.ondigitalocean.app/api/v2/tables/m1kydl23bixj8y4/records?viewId=vwr6qfjvqsdlpc7t&limit=400&shuffle=0&offset=0", {
        headers: {
          "accept": "application/json",
          "xc-auth": "0PUFCoQXi632mkc9ZWSpv5ea9evnYKYE-TaOFE_F",
          "xc-token": "0PUFCoQXi632mkc9ZWSpv5ea9evnYKYE-TaOFE_F"
        }
      });
      const data = await res.json();
      const records = data.list;

      // Build structure: name -> date -> [records]
      attendanceMap = {};
      records.forEach(r => {
        const name = r.displayedName || "Unknown";
        try {
          const meta = JSON.parse(r.metadata);
          const timestamp = new Date(meta.timestamp);
          const date = timestamp.toISOString().split("T")[0];
          if (!attendanceMap[name]) attendanceMap[name] = {};
          if (!attendanceMap[name][date]) attendanceMap[name][date] = [];
          attendanceMap[name][date].push({
            time: timestamp,
            meta: meta,
            raw: r
          });
        } catch (e) {
          console.error("Metadata parse error:", e);
        }
      });

      // Render summary
      const tbody = document.querySelector("#attendanceTable tbody");
      tbody.innerHTML = "";
      Object.entries(attendanceMap).forEach(([name, days]) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${name}</td><td>${Object.keys(days).length}</td>`;
        tr.addEventListener("click", () => showDetails(name, days));
        tbody.appendChild(tr);
      });

      document.querySelector("#total").textContent =
        `Total Attendance Entries: ${records.length}`;
    }

    function showDetails(name, days) {
      const modal = document.getElementById("detailModal");
      const tbody = document.querySelector("#detailTable tbody");
      const title = document.getElementById("modalTitle");
      tbody.innerHTML = "";
      title.textContent = `Attendance Details for ${name}`;

      Object.entries(days).forEach(([date, recs]) => {
        const timestamps = recs.map(r => r.time).sort((a,b) => a - b);
        const diffHrs = (timestamps[timestamps.length - 1] - timestamps[0]) / (1000 * 60 * 60);
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td style="cursor:pointer; text-decoration:underline;">${date}</td>
          <td class="${diffHrs < 8 ? 'hours-low' : ''}">${diffHrs.toFixed(2)} hrs</td>
        `;
        tr.querySelector("td").addEventListener("click", (e) => {
          e.stopPropagation();
          showRecords(name, date, recs);
        });
        tbody.appendChild(tr);
      });

      modal.style.display = "flex";
    }

    function showRecords(name, date, records) {
      const modal = document.getElementById("recordModal");
      const tbody = document.querySelector("#recordTable tbody");
      const title = document.getElementById("recordTitle");
      tbody.innerHTML = "";
      title.textContent = `Records for ${name} on ${date}`;

      records.sort((a,b) => a.time - b.time).forEach(r => {
        const meta = r.meta || {};
        const timeStr = r.time.toLocaleTimeString();
        const action = meta.action || "Recorded";

        // Handle fileAttachment column (array of objects)
        let photoHtml = "—";
        if (Array.isArray(r.raw.fileAttachment) && r.raw.fileAttachment.length > 0) {
          const firstFile = r.raw.fileAttachment[0];
          if (firstFile.url) {
            photoHtml = `<img src="${firstFile.url}" class="record-photo" alt="photo" />`;
          }
        }

        // ✅ Added annotation
        const annotation = r.raw.annotation || "—";

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${timeStr}</td>
          <td>${action}</td>
          <td>${photoHtml}</td>
          <td>${annotation}</td>
        `;
        tbody.appendChild(tr);
      });

      modal.style.display = "flex";
    }

    // Close modals
    document.getElementById("closeModal").onclick = () => document.getElementById("detailModal").style.display = "none";
    document.getElementById("closeRecordModal").onclick = () => document.getElementById("recordModal").style.display = "none";
    window.onclick = e => {
      if (e.target.classList.contains("modal")) e.target.style.display = "none";
    };

    loadAttendance();
  </script>
</body>
</html>
