<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Weekly Calendar View</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs/dayjs.min.js"></script>
  <style>
    .calendar-grid {
      display: grid;
      grid-template-columns: 80px repeat(7, 1fr);
      border: 1px solid #dee2e6;
    }
    .calendar-header {
      background: #f8f9fa;
      text-align: center;
      font-weight: bold;
      padding: 0.5rem;
      border-bottom: 1px solid #dee2e6;
      border-right: 1px solid #dee2e6;
    }
    .calendar-time-label {
      padding: 0.5rem;
      border-bottom: 1px solid #dee2e6;
      border-right: 1px solid #dee2e6;
      background: #f1f1f1;
      font-size: 0.75rem;
    }
    .calendar-cell {
      border-bottom: 1px solid #dee2e6;
      border-right: 1px solid #dee2e6;
      min-height: 50px;
      padding: 2px;
      font-size: 0.75rem;
      position: relative;
    }
    .event {
      color: white;
      border-radius: 0.25rem;
      padding: 2px 4px;
      font-size: 0.7rem;
      position: absolute;
      left: 2px;
      right: 2px;
    }
    .WAITING_PAYMENT { background-color: #ffc107; }
    .PAYMENT_VERIFIED { background-color: #0dcaf0; }
    .SCHEDULE_CONFIRMED { background-color: #198754; }
    .SCHEDULE_DONE { background-color: #6c757d; }
    .CANCELLED, .REFUNDED { background-color: #dc3545; }

    @media (max-width: 768px) {
      .calendar-grid {
        grid-template-columns: 40px repeat(7, 1fr);
        font-size: 0.6rem;
      }
    }
  </style>
</head>
<body class="bg-light p-4">
  <div class="container-fluid">
    <h2 class="mb-4">Weekly Calendar</h2>
    <div class="row mb-3">
      <div class="col-md-4 col-12">
        <select id="providerSelect" class="form-select">
          <option value="">All Providers</option>
          <option value="7c7b7b03-b095-48e2-ba3b-9b18e111baac" data-type="KIDS_THERAPHY">Risydah Amani Mujahidah - KIDS_THERAPHY</option>
          <option value="fbbdb41d-0635-42c6-ba82-6a110e459e26" data-type="KIDS_THERAPHY">Maulida Rahmatillah - KIDS_THERAPHY</option>
          <option value="08c8a8ed-e61f-1b58-8cca-afb362bb64da" data-type="KIDS_THERAPHY">Artha Nisa Thohiroh Triyantari - KIDS_THERAPHY</option>
          <option value="1afc9f11-af2c-492c-9658-341d63f87a77" data-type="KIDS_THERAPHY">Anindita Sylvie Asyura Putri - KIDS_THERAPHY</option>
          <option value="230aaee5-5a63-416a-834d-335b4afa4398" data-type="KIDS_PSYCHOLOGY">Gracia Ivonika - KIDS_PSYCHOLOGY</option>
          <option value="e2e1520b-7e15-490a-be61-dd2d4b490bd6" data-type="KIDS_PSYCHOLOGY">Mariska - KIDS_PSYCHOLOGY</option>
          <option value="e30994bc-2806-42fe-a461-e584941d8659" data-type="KIDS_PSYCHOLOGY">Joe Irene - KIDS_PSYCHOLOGY</option>
        </select>
      </div>
      <div class="col-md-8 col-12 text-end">
        <button class="btn btn-secondary" onclick="changeDate(-1)">Prev</button>
        <button class="btn btn-info" onclick="resetToToday()">Today</button>
        <button class="btn btn-secondary" onclick="changeDate(1)">Next</button>
      </div>
    </div>

    <div id="calendarView" class="calendar-grid"></div>
  </div>

  <script>
    let currentStartDate = dayjs().startOf('week');

    function fetchCalendar() {
      const start = currentStartDate.format('YYYY-MM-DD 08:00:00');
      const end = currentStartDate.add(6, 'day').format('YYYY-MM-DD 18:00:00');
      const providerSelect = document.getElementById('providerSelect');
      const providerId = providerSelect.value;
      const productType = providerSelect.options[providerSelect.selectedIndex].dataset.type || "";

      const payload = {
        filter: {
          purchaser_id: "",
          product_type: productType,
          provider_id: providerId,
          author_id: ""
        },
        start_date: start,
        end_date: end
      };

      axios.post('https://www.gopher.bicarakan.id/rujak/calendar/product/list', payload)
        .then(response => displayCalendar(response.data.data.product_summary_list))
        .catch(error => alert('Failed to fetch calendar data.'));
    }

    function displayCalendar(events) {
      const container = document.getElementById('calendarView');
      container.innerHTML = '';

      const days = [];
      for (let i = 0; i < 7; i++) {
        days.push(currentStartDate.add(i, 'day').format('YYYY-MM-DD'));
      }

      const hours = Array.from({ length: 10 }, (_, i) => `${(8 + i).toString().padStart(2, '0')}:00`);

      // Header row
      container.innerHTML += `<div class="calendar-header"></div>` + days.map(d => `<div class="calendar-header">${dayjs(d).format('ddd D')}</div>`).join('');

      for (const hour of hours) {
        container.innerHTML += `<div class="calendar-time-label">${hour}</div>`;
        for (const day of days) {
          const matches = events.filter(e => {
            return e.miscproduct_date === day && e.miscproduct_start_time === hour;
          });

          container.innerHTML += `<div class="calendar-cell" style="display: flex; flex-direction: column; gap: 4px;">${matches.map(m => {
            const start = dayjs(`${m.miscproduct_date} ${m.miscproduct_start_time}`);
            const end = dayjs(`${m.miscproduct_date} ${m.miscproduct_end_time}`);
            const duration = end.diff(start, 'minute') / 60; // hour unit
            return `<div class='event ${m.miscproduct_status}' style='height:${duration * 50}px; position: relative;'>
              <strong>${m.miscproduct_title || 'No Title'}</strong><br>
              <small>${m.miscproduct_start_time} - ${m.miscproduct_end_time}</small><br>
              <small>${m.miscproduct_status}</small>
            </div>`;
          }).join('')}</div>`;
        }
      }
    }

    function changeDate(offset) {
      currentStartDate = currentStartDate.add(offset * 7, 'day');
      fetchCalendar();
    }

    function resetToToday() {
      currentStartDate = dayjs().startOf('week');
      fetchCalendar();
    }

    document.getElementById('providerSelect').addEventListener('change', fetchCalendar);
    window.onload = fetchCalendar;
  </script>
</body>
</html>