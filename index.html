<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Calendar Product View</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs/dayjs.min.js"></script>
</head>
<body class="bg-light p-4">
  <div class="container">
    <h2 class="mb-4">Product Calendar</h2>

    <div class="row mb-3">
      <div class="col-md-4">
        <select id="providerSelect" class="form-select">
          <option value="">All Providers</option>
          <option value="7c7b7b03-b095-48e2-ba3b-9b18e111baac" data-type="KIDS_THERAPHY">Risydah Amani Mujahidah - KIDS_THERAPHY</option>
          <option value="fbbdb41d-0635-42c6-ba82-6a110e459e26" data-type="KIDS_THERAPHY">Maulida Rahmatillah - KIDS_THERAPHY</option>
          <option value="08c8a8ed-e61f-1b58-8cca-afb362bb64da" data-type="KIDS_THERAPHY">Artha Nisa Thohiroh Triyantari - KIDS_THERAPHY</option>
          <option value="1afc9f11-af2c-492c-9658-341d63f87a77" data-type="KIDS_THERAPHY">Anindita Sylvie Asyura Putri - KIDS_THERAPHY</option>
          <option value="230aaee5-5a63-416a-834d-335b4afa4398" data-type="KIDS_PSYCHOLOGY">Gracia Ivonika - KIDS_PSYCHOLOGY</option>
          <option value="e2e1520b-7e15-490a-be61-dd2d4b490bd6" data-type="KIDS_PSYCHOLOGY">Mariska - KIDS_PSYCHOLOGY</option>
          <option value="e30994bc-2806-42fe-a461-e584941d8659" data-type="KIDS_PSYCHOLOGY">Joe Irene - KIDS_PSYCHOLOGY</option>
        </select>
      </div>
      <div class="col-md-8 text-end">
        <button class="btn btn-secondary" onclick="changeDate(-1)">Prev</button>
        <button class="btn btn-info" onclick="resetToToday()">Today</button>
        <button class="btn btn-secondary" onclick="changeDate(1)">Next</button>
      </div>
    </div>

    <div id="calendarView" class="row g-3"></div>
  </div>

  <script>
    let currentStartDate = dayjs().startOf('day');

    function fetchCalendar() {
      const start = currentStartDate.format('YYYY-MM-DD 08:00:00');
      const end = currentStartDate.add(3, 'day').format('YYYY-MM-DD 18:00:00');
      const providerSelect = document.getElementById('providerSelect');
      const providerId = providerSelect.value;
      const productType = providerSelect.options[providerSelect.selectedIndex].dataset.type || "";

      const payload = {
        filter: {
          purchaser_id: "",
          product_type: productType,
          provider_id: providerId,
          author_id: ""
        },
        start_date: start,
        end_date: end
      };

      axios.post('https://www.gopher.bicarakan.id/rujak/calendar/product/list', payload)
        .then(response => {
          displayCalendar(response.data.data.product_summary_list);
        })
        .catch(error => {
          console.error(error);
          alert('Failed to fetch calendar data.');
        });
    }

    function displayCalendar(events) {
      const container = document.getElementById('calendarView');
      container.innerHTML = '';

      const grouped = {};
      events.forEach(item => {
        if (!grouped[item.miscproduct_date]) grouped[item.miscproduct_date] = [];
        grouped[item.miscproduct_date].push(item);
      });

      Object.keys(grouped).sort().forEach(date => {
        const card = document.createElement('div');
        card.className = 'col-md-6 col-lg-4';
        card.innerHTML = `
          <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
              ${date}
            </div>
            <div class="card-body">
              ${grouped[date].map(ev => `
                <div class="mb-2">
                  <strong>${ev.miscproduct_title || 'No Title'}</strong><br>
                  ${ev.miscproduct_start_time} - ${ev.miscproduct_end_time}<br>
                  <span class="badge bg-${ev.miscproduct_status === 'SCHEDULE_CONFIRMED' ? 'success' : 'warning'}">${ev.miscproduct_status}</span>
                </div>
              `).join('')}
            </div>
          </div>
        `;
        container.appendChild(card);
      });
    }

    function changeDate(offset) {
      currentStartDate = currentStartDate.add(offset * 4, 'day');
      fetchCalendar();
    }

    function resetToToday() {
      currentStartDate = dayjs().startOf('day');
      fetchCalendar();
    }

    document.getElementById('providerSelect').addEventListener('change', fetchCalendar);
    window.onload = fetchCalendar;
  </script>
</body>
</html>
